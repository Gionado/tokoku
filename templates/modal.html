<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 id="modalTitle" class="text-xl font-semibold text-gray-900">
          Create New Product
        </h3>
        <p id="modalDescription" class="text-sm text-gray-600 mt-1">Share your football products with the community</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="productForm" class="space-y-4">
        {% csrf_token %}
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" name="name" id="name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea name="description" id="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required></textarea>
        </div>
        <div>
          <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" name="price" id="price" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
        </div>
        <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
            <select name="category" id="category" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
                <option value="jersey">Jersey</option>
                <option value="sepatu">Sepatu</option>
                <option value="celana">Celana</option>
                <option value="bola">Bola</option>
                <option value="lain lain">Lain-lain</option>
            </select>
        </div>
        <div>
            <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
            <input type="url" name="thumbnail" id="thumbnail" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="https://example.com/image.jpg">
        </div>
        <div class="flex items-center">
            <input type="checkbox" name="is_featured" id="is_featured" class="h-4 w-4 text-yellow-900 border-gray-300 rounded">
            <label for="is_featured" class="ml-2 block text-sm text-gray-900">Featured Product</label>
        </div>
      </form>
    </div>
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
      <button type="button" id="cancelButton" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="order-1 sm:order-2 flex-1 bg-yellow-900 text-white px-6 py-3 rounded-md font-medium hover:bg-yellow-800 transition-colors">Create Product</button>
    </div>
  </div>
</div>

<div id="registerModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="registerModalContent" class="bg-white rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-gray-900">
          Create Your Account
        </h3>
        <p class="text-sm text-gray-600 mt-1">Join the TokoKu community</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideRegisterModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="registerFormModal" class="space-y-4">
        {% csrf_token %}
        
        <div id="register-errors" class="mb-4"></div>

        <div>
          <label for="reg-username" class="block text-sm font-medium text-gray-700">Username</label>
          <input type="text" id="reg-username" name="username" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Choose a unique username" required>
        </div>
        <div>
          <label for="reg-password" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="reg-password" name="password1" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Create a strong password" required>
        </div>
        <div>
          <label for="reg-password2" class="block text-sm font-medium text-gray-700">Confirm Password</label>
          <input type="password" id="reg-password2" name="password2" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Confirm your password" required>
        </div>
      </form>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
      <button type="button" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center" onclick="hideRegisterModal()">Cancel</button>
      <button type="submit" id="submitRegister" form="registerFormModal" class="order-1 sm:order-2 flex-1 bg-yellow-900 text-white px-6 py-3 rounded-md font-medium hover:bg-yellow-800 transition-colors">Create Account</button>
    </div>
  </div>
</div>

<script>
  function showModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      modal.classList.remove('hidden'); 
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      }, 50); 
  }

  function hideModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');
      const form = document.getElementById('productForm');

      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');
      
      // PERUBAHAN: Reset form ke kondisi "Create" setiap kali modal ditutup
      setTimeout(() => {
        modal.classList.add('hidden');
        form.reset();
        form.removeAttribute('data-product-id');
        form.removeAttribute('data-is-edit');
        
        document.getElementById('modalTitle').textContent = 'Create New Product';
        document.getElementById('modalDescription').textContent = 'Share your football products with the community';
        document.getElementById('submitProduct').textContent = 'Create Product';
      }, 150); 
  }

  // Helper function to get CSRF token from cookies
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.startsWith(name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // FUNGSI UNTUK CREATE (AJAX)
  async function addProductEntry() {
    const form = document.getElementById('productForm');
    const formData = new FormData(form);

    try {
      const response = await fetch("{% url 'main:add_product_entry_ajax' %}", {
        method: "POST",
        body: formData,
        // FormData tidak butuh header 'X-CSRFToken' jika menggunakan {% csrf_token %}
      });

      if (!response.ok) {
        throw new Error('Failed to create product');
      }

      hideModal();
      // PERBAIKAN: showToast disesuaikan dengan definisi di base.html
      showToast('Product successfully created!'); 
      document.dispatchEvent(new CustomEvent('productAdded'));
      
    } catch (error) {
      console.error('Error adding product:', error);
      showToast('Failed to create product. Please try again.');
    }
  }

  async function updateProduct() {
    const form = document.getElementById('productForm');
    const productId = form.dataset.productId;
    const url = `{% url 'main:edit_product_ajax' 0 %}`.replace('0', productId);
    const productData = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        category: document.getElementById('category').value,
        thumbnail: document.getElementById('thumbnail').value,
        is_featured: document.getElementById('is_featured').checked,
    };

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(productData) // Kirim sebagai JSON
        });

        if (!response.ok) {
            throw new Error('Failed to update product');
        }

        hideModal();
        showToast('Product successfully updated!');
        document.dispatchEvent(new CustomEvent('productAdded')); // Pakai event yang sama untuk refresh

    } catch (error) {
        console.error('Error updating product:', error);
        showToast('Failed to update product. Please try again.');
    }
  }


  // PERUBAHAN BESAR: Event listener form submit sekarang bisa membedakan create dan update
  document.getElementById("productForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const form = e.target;
    // Cek atribut data-is-edit yang di-set oleh showEditModal
    if (form.dataset.isEdit === 'true') {
        updateProduct();
    } else {
        addProductEntry();
    }
  });

  function showRegisterModal() {
    const modal = document.getElementById('registerModal');
    modal.classList.remove('hidden');
  }

  function hideRegisterModal() {
    const modal = document.getElementById('registerModal');
    const form = document.getElementById('registerFormModal');
    const errorContainer = document.getElementById('register-errors');

    modal.classList.add('hidden');
    form.reset(); // Clear form fields
    errorContainer.innerHTML = ''; // Clear any previous error messages
  }

  // --- AJAX Form Submission for Registration ---
  document.getElementById("registerFormModal").addEventListener("submit", async (e) => {
    e.preventDefault(); // Prevent default form submission

    const form = e.target;
    const formData = new FormData(form);
    const errorContainer = document.getElementById('register-errors');
    errorContainer.innerHTML = ''; // Clear previous errors

    try {
      const response = await fetch("{% url 'main:register' %}", {
        method: "POST",
        body: formData,
        // No need for 'X-CSRFToken' header with FormData if {% csrf_token %} is in the form
      });

      const data = await response.json();

      if (data.success) {
        hideRegisterModal();
        showToast(data.message, 'success'); // Assuming showToast is globally available from base.html
        
        setTimeout(() => {
            const params = new URLSearchParams();
            params.set('toast', 'Your account has been successfully created! Please login.');
            params.set('toast_type', 'success');
            window.location.href = data.redirect_url + '?' + params.toString();
        }, 1500);

      } else {
        // Display validation errors inside the modal
        let errorHtml = '<div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700"><ul>';
        for (const field in data.errors) {
            data.errors[field].forEach(error => {
                errorHtml += `<li class="list-disc ml-4">${error}</li>`;
            });
        }
        errorHtml += '</ul></div>';
        errorContainer.innerHTML = errorHtml;
        showToast(data.message || 'Registration failed', 'error');
      }

    } catch (error) {
      console.error('Error during registration:', error);
      showToast('An unexpected error occurred. Please try again.', 'error');
    }
  });
</script>